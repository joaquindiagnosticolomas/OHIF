!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","gl-matrix"],t):"object"==typeof exports?exports.cornerstoneStreamingImageVolumeLoader=t(require("@cornerstonejs/core"),require("gl-matrix")):e.cornerstoneStreamingImageVolumeLoader=t(e.cornerstone3D,e.window)}(self,(function(e,t){return function(){var r={162:function(e,t,r){e.exports=r(47)},47:function(e){var t=function(e){"use strict";var t,r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof p?t:p,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n=f;return function(a,o){if(n===d)throw new Error("Generator is already running");if(n===g){if("throw"===a)throw o;return T()}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=E(i,r);if(s){if(s===h)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===f)throw n=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var c=l(e,t,r);if("normal"===c.type){if(n=r.done?g:m,c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n=g,r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var f="suspendedStart",m="suspendedYield",d="executing",g="completed",h={};function p(){}function v(){}function y(){}var I={};c(I,o,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(O([])));b&&b!==r&&n.call(b,o)&&(I=b);var P=y.prototype=p.prototype=Object.create(I);function x(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(a,o,i,s){var c=l(e[a],e,o);if("throw"!==c.type){var u=c.arg,f=u.value;return f&&"object"==typeof f&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(f).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,n){function o(){return new t((function(t,a){r(e,n,t,a)}))}return a=a?a.then(o,o):o()}}function E(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,E(e,r),"throw"===r.method))return h;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var a=l(n,e.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,h;var o=a.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,h):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,h)}function D(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(D,this),this.reset(!0)}function O(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function r(){for(;++a<e.length;)if(n.call(e,a))return r.value=e[a],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}return{next:T}}function T(){return{value:t,done:!0}}return v.prototype=y,c(P,"constructor",y),c(y,"constructor",v),v.displayName=c(y,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,c(e,s,"GeneratorFunction")),e.prototype=Object.create(P),e},e.awrap=function(e){return{__await:e}},x(S.prototype),c(S.prototype,i,(function(){return this})),e.AsyncIterator=S,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new S(u(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},x(P),c(P,s,"Generator"),c(P,o,(function(){return this})),c(P,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function a(n,a){return s.type="throw",s.arg=e,r.next=n,a&&(r.method="next",r.arg=t),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),L(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;L(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:O(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),h}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}},953:function(t){"use strict";t.exports=e},976:function(e){"use strict";e.exports=t}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}};return r[e](o,o.exports,a),o.exports}a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,{a:t}),t},a.d=function(e,t){for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function t(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(t,r){if(t){if("string"==typeof t)return e(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,r):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function n(e){return function(){var t=this,n=arguments;return new Promise((function(a,o){var i=e.apply(t,n);function s(e){r(i,a,o,s,c,"next",e)}function c(e){r(i,a,o,s,c,"throw",e)}s(void 0)}))}}a.r(o),a.d(o,{StreamingDynamicImageVolume:function(){return C},StreamingImageVolume:function(){return O},cornerstoneStreamingDynamicImageVolumeLoader:function(){return V},cornerstoneStreamingImageVolumeLoader:function(){return A}});var i=a(162),s=a.n(i),c=a(953),u=a(976);function l(e){var t,r=e[0],n=c.metaData.get("imagePixelModule",r),a=n.pixelRepresentation,o=n.bitsAllocated,i=n.bitsStored,s=n.highBit,u=n.photometricInterpretation,l=n.samplesPerPixel,f=[],m=c.metaData.get("voiLutModule",r);if(m){var d=m.windowWidth,g=m.windowCenter;if(t=null==m?void 0:m.voiLUTFunction,Array.isArray(d))for(var h=0;h<d.length;h++)f.push({windowWidth:d[h],windowCenter:g[h]});else f.push({windowWidth:d,windowCenter:g})}else f.push({windowWidth:void 0,windowCenter:void 0});var p=c.metaData.get("generalSeriesModule",r),v=p.modality,y=p.seriesInstanceUID,I=c.metaData.get("imagePlaneModule",r);return{BitsAllocated:o,BitsStored:i,SamplesPerPixel:l,HighBit:s,PhotometricInterpretation:u,PixelRepresentation:a,Modality:v,ImageOrientationPatient:I.imageOrientationPatient,PixelSpacing:I.pixelSpacing,FrameOfReferenceUID:I.frameOfReferenceUID,Columns:I.columns,Rows:I.rows,voiLut:f,VOILUTFunction:t,SeriesInstanceUID:y}}function f(e,t){var r,n,a=c.metaData.get("imagePlaneModule",e[0]).imagePositionPatient,o=u.vec3.create(),i="wadouri"===e[0].split(":")[0];function s(e){var r=c.metaData.get("imagePlaneModule",e).imagePositionPatient,n=u.vec3.create();return u.vec3.sub(n,a,r),u.vec3.dot(n,t)}if(u.vec3.set(o,a[0],a[1],a[2]),i){var l=[e[0],e[Math.floor(e.length/2)]];r=e,s(l[0])-s(l[1])<0&&r.reverse();var f=c.metaData.get("imagePlaneModule",l[1]);if(!f)throw new Error("Incomplete metadata required for volume construction.");var m=u.vec3.create();u.vec3.sub(m,a,f.imagePositionPatient);var d=u.vec3.dot(m,t);n=Math.abs(d)/Math.floor(e.length/2)}else{var g=e.map((function(e){return{distance:s(e),imageId:e}}));g.sort((function(e,t){return t.distance-e.distance})),r=g.map((function(e){return e.imageId}));var h=g.length;n=Math.abs(g[h-1].distance-g[0].distance)/(h-1)}var p=c.metaData.get("imagePlaneModule",r[0]),v=p.imagePositionPatient,y=p.sliceThickness,I=(0,c.getConfiguration)().rendering.strictZSpacingForVolumeViewport;return 0!==n||I||(y?(console.log("Could not calculate zSpacing. Using sliceThickness"),n=y):(console.log("Could not calculate zSpacing. The VolumeViewport visualization is compromised. Setting zSpacing to 1 to render"),n=1)),{zSpacing:n,origin:v,sortedImageIds:r}}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function g(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function v(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function I(e,t){if(t&&("object"===y(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var P=function(e){var t=function(e){for(var t=(0,c.getRenderingEngines)(),r=[],n=0;n<t.length;n++){var a=t[n],o=c.utilities.getViewportsWithVolumeId(e,a.id);o.length&&r.push({renderingEngine:a,viewportIds:o.map((function(e){return e.id}))})}return r}(e);t&&t.length&&t.forEach((function(e){var t=e.renderingEngine,r=e.viewportIds;t.hasBeenDestroyed||t.renderViewports(r)}))};function x(e,t){var r=e.length,n=t.rescaleSlope,a=t.rescaleIntercept,o=t.suvbw;if("PT"===t.modality){if("number"!=typeof o)return e;for(var i=0;i<r;i++)e[i]=o*(e[i]*n+a)}else for(var s=0;s<r;s++)e[s]=e[s]*n+a;return e}function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var D=c.Enums.RequestType.Prefetch,L=c.utilities.getMinMax,_=function(e){v(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return I(this,e)});function a(e,t){var r;return m(this,a),b(h(r=n.call(this,e)),"framesLoaded",0),b(h(r),"framesProcessed",0),b(h(r),"numFrames",void 0),b(h(r),"cornerstoneImageMetaData",null),b(h(r),"loadStatus",void 0),b(h(r),"cancelLoading",(function(){var e=h(r).loadStatus;e&&e.loading&&(e.loading=!1,e.cancelled=!0,r.clearLoadCallbacks(),c.imageLoadPoolManager.filterRequests((function(e){return e.additionalDetails.volumeId!==r.volumeId})))})),b(h(r),"load",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=h(r),a=n.imageIds,o=n.loadStatus,i=n.numFrames;if(!0!==o.loading){var s=r.loadStatus.loaded,c=a.length;s?e&&e({success:!0,framesLoaded:c,framesProcessed:c,numFrames:i,totalNumFrames:c}):(e&&r.loadStatus.callbacks.push(e),r._prefetchImageIds(t))}else console.log("loadVolume: Loading is already in progress for ".concat(r.volumeId))})),b(h(r),"getImageIdsRequests",(function(e,t,n){var a,o=h(r).loadStatus,i=o.cachedFrames,s=h(r),u=s.vtkOpenGLTexture,l=s.imageData,f=s.metadata,m=s.volumeId,d=f.FrameOfReferenceUID,g=t.buffer,p=e.length,v=t.length/p,y=g.byteLength/p;if(t instanceof Uint8Array)a="Uint8Array";else if(t instanceof Float32Array)a="Float32Array";else if(t instanceof Uint16Array)a="Uint16Array";else{if(!(t instanceof Int16Array))throw new Error("Unsupported array type");a="Int16Array"}var I,w,b=r.imageIds.length;function x(e){(e.framesProcessed>w||e.framesProcessed===e.totalNumFrames)&&(w+=I,P(m)),e.framesProcessed===e.totalNumFrames&&o.callbacks.forEach((function(t){return t(e)}))}w=I=.02*b;var S=function(e,t,n){var a=r._imageIdIndexToFrameIndex(t);i[t]=!0,r.framesLoaded++,r.framesProcessed++,u.setUpdatedFrame(a),l.modified();var s={FrameOfReferenceUID:d,imageVolume:e};(0,c.triggerEvent)(c.eventTarget,c.Enums.Events.IMAGE_VOLUME_MODIFIED,s),r.framesProcessed===b?(o.loaded=!0,o.loading=!1,x({success:!0,imageIdIndex:t,imageId:n,framesLoaded:r.framesLoaded,framesProcessed:r.framesProcessed,numFrames:p,totalNumFrames:b}),o.callbacks=[]):x({success:!0,imageIdIndex:t,imageId:n,framesLoaded:r.framesLoaded,framesProcessed:r.framesProcessed,numFrames:p,totalNumFrames:b})};function E(e,t,r){this.framesProcessed++,this.framesProcessed===b?(o.loaded=!0,o.loading=!1,x({success:!1,imageId:r,imageIdIndex:t,error:e,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,numFrames:p,totalNumFrames:b}),o.callbacks=[]):x({success:!1,imageId:r,imageIdIndex:t,error:e,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,numFrames:p,totalNumFrames:b});var n={error:e,imageIdIndex:t,imageId:r};(0,c.triggerEvent)(c.eventTarget,c.Enums.Events.IMAGE_LOAD_ERROR,n)}var L=e.map((function(e,s){var u=r.getImageIdIndex(e);if(i[u])return r.framesLoaded++,void r.framesProcessed++;var l=c.metaData.get("modalityLutModule",e)||{},f=c.metaData.get("generalSeriesModule",e)||{},m={rescaleSlope:l.rescaleSlope,rescaleIntercept:l.rescaleIntercept,modality:f.modality};if("PT"===m.modality){var d=c.metaData.get("scalingModule",e);d&&(r._addScalingToVolume(d),m.suvbw=d.suvbw)}return{callLoadImage:function(e,n,a){return c.imageLoader.loadImage(e,a).then((function(i){!function(e,t,r){if(e.buffer instanceof ArrayBuffer){var n=r.targetBuffer.offset,a=r.targetBuffer.length,o=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){var i=new Float32Array(o);if(i.length!==a)throw"Error pixelData length does not match frame length";e.set(i,n/4)}if(e instanceof Int16Array){var s=new Int16Array(o);if(s.length!==a)throw"Error pixelData length does not match frame length";e.set(s,n/2)}if(e instanceof Uint16Array){var c=new Uint16Array(o);if(c.length!==a)throw"Error pixelData length does not match frame length";e.set(c,n/2)}if(e instanceof Uint8Array){var u=new Uint8Array(o);if(u.length!==a)throw"Error pixelData length does not match frame length";e.set(u,n/1)}}catch(e){console.error(e)}}}(t,i,a),function(e,n,a){var i=r._imageIdIndexToFrameIndex(e),s=c.cache.getCachedImageBasedOnImageURI(n);if(o.cancelled)console.warn("volume load cancelled, returning for imageIdIndex: ",e);else{if(!s||!s.image)return S(h(r),e,n);var u=r._scaleIfNecessary(s.image,a),l=r.cornerstoneImageMetaData,f=l.pixelsPerImage,m=l.bytesPerImage,d=t.constructor,p=m*i,v=m/f;t.BYTES_PER_ELEMENT!==v&&(p*=t.BYTES_PER_ELEMENT/v);var y=new d(g,p,f);s.imageLoadObject.promise.then((function(t){y.set(u),S(h(r),e,n)})).catch((function(t){E.call(h(r),t,e,n)}))}}(n,e,m)}),(function(t){E.call(h(r),t,n,e)}))},imageId:e,imageIdIndex:u,options:{targetBuffer:{arrayBuffer:g instanceof ArrayBuffer?void 0:g,offset:s*y,length:v,type:a},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:m}},priority:n,requestType:D,additionalDetails:{volumeId:r.volumeId}}}));return L})),r.imageIds=t.imageIds,r.loadStatus=t.loadStatus,r.numFrames=r._getNumFrames(),r._createCornerstoneImageMetaData(),r}return g(a,[{key:"_getNumFrames",value:function(){var e=this.imageIds,t=this.scalarData,r=this.isDynamicVolume()?t.length:1;return e.length/r}},{key:"_getScalarDataLength",value:function(){var e=this.scalarData;return this.isDynamicVolume()?e[0].length:e.length}},{key:"_createCornerstoneImageMetaData",value:function(){var e=this.numFrames;if(0!==e){var t=this.sizeInBytes/e,r=this._getScalarDataLength()/this.numVoxels,n=this.dimensions[0]*this.dimensions[1]*r,a=this.metadata,o=a.PhotometricInterpretation,i=a.voiLut,s=a.VOILUTFunction,c=[],u=[];i&&i.length&&(c=i.map((function(e){return e.windowCenter})),u=i.map((function(e){return e.windowWidth})));var l=r>1;this.cornerstoneImageMetaData={bytesPerImage:t,numComponents:r,pixelsPerImage:n,windowCenter:c,windowWidth:u,color:l,spacing:this.spacing,dimensions:this.dimensions,PhotometricInterpretation:o,voiLUTFunction:s,invert:"MONOCHROME1"===o}}}},{key:"_imageIdIndexToFrameIndex",value:function(e){return e%this.numFrames}},{key:"getScalarDataArrays",value:function(){return this.isDynamicVolume()?this.scalarData:[this.scalarData]}},{key:"_getScalarDataByImageIdIndex",value:function(e){if(e<0||e>=this.imageIds.length)throw new Error("imageIdIndex out of range");return this.getScalarDataArrays()[Math.floor(e/this.numFrames)]}},{key:"invalidateVolume",value:function(e){for(var t=this.imageData,r=this.vtkOpenGLTexture,n=this.numFrames,a=0;a<n;a++)r.setUpdatedFrame(a);t.modified(),e&&P(this.volumeId)}},{key:"clearLoadCallbacks",value:function(){this.loadStatus.callbacks=[]}},{key:"getImageLoadRequests",value:function(e){throw new Error("Abstract method")}},{key:"_prefetchImageIds",value:function(e){var t=this;this.loadStatus.loading=!0,this.getImageLoadRequests(e).reverse().forEach((function(e){if(e){var r=e.callLoadImage,n=e.imageId,a=e.imageIdIndex,o=e.options,i=e.priority,s=e.requestType,u=e.additionalDetails;c.imageLoadPoolManager.addRequest(r.bind(t,n,a,o),s,u,i)}}))}},{key:"_scaleIfNecessary",value:function(e,t){var r,n=null===(r=e.preScale)||void 0===r?void 0:r.scaled,a=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!n&&a)return e.getPixelData().slice(0);if(!n&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope)return x(e.getPixelData().slice(0),t);var o=t.rescaleSlope,i=t.rescaleIntercept,s=t.suvbw,c=e.preScale.scalingParameters,u=c.rescaleSlope,l=c.rescaleIntercept,f=c.suvbw;if(o===u&&i===l&&s===f)return e.getPixelData();var m=s/f,d=o/u,g=i-l*d;return x(e.getPixelData().slice(0),E(E({},t),{},{rescaleSlope:d,rescaleIntercept:g,suvbw:m}))}},{key:"_addScalingToVolume",value:function(e){if(!this.scaling){var t=e.suvbw,r=e.suvlbm,n=e.suvbsa,a={};r&&(a.suvbwToSuvlbm=r/t),n&&(a.suvbwToSuvbsa=n/t),this.scaling={PET:a},this.isPrescaled=!0}}},{key:"_removeFromCache",value:function(){c.cache.removeVolumeLoadObject(this.volumeId)}},{key:"convertToCornerstoneImage",value:function(e,t){var r=this.imageIds,n=this._imageIdIndexToFrameIndex(t),a=this.cornerstoneImageMetaData,o=a.bytesPerImage,i=a.pixelsPerImage,s=a.windowCenter,u=a.windowWidth,l=a.numComponents,f=a.color,m=a.dimensions,d=a.spacing,g=a.invert,h=a.voiLUTFunction,p=this._getScalarDataByImageIdIndex(t),v=p.buffer,y=p.constructor,I=o/i,w=o*n;p.BYTES_PER_ELEMENT!==I&&(w*=p.BYTES_PER_ELEMENT/I);var b=new y(i),P=new y(v,w,i);b.set(P);var x=r[t],S=c.metaData.get("modalityLutModule",x)||{},E=L(b),D={imageId:e,intercept:S.rescaleIntercept?S.rescaleIntercept:0,windowCenter:s,windowWidth:u,voiLUTFunction:h,color:f,numComps:l,rows:m[0],columns:m[1],sizeInBytes:b.byteLength,getPixelData:function(){return b},minPixelValue:E.min,maxPixelValue:E.max,slope:S.rescaleSlope?S.rescaleSlope:1,getCanvas:void 0,height:m[0],width:m[1],rgba:void 0,columnPixelSpacing:d[0],rowPixelSpacing:d[1],invert:g};return{promise:Promise.resolve(D)}}},{key:"_convertToImages",value:function(){for(var e=this.sizeInBytes,t=this.imageIds.length,r=this.cornerstoneImageMetaData.bytesPerImage,n=c.cache.decacheIfNecessaryUntilBytesAvailable(e,this.imageIds),a=0;a<t;a++){var o=this.imageIds[a];n-=r;var i=this.convertToCornerstoneImage(o,a);if(c.cache.putImageLoadObject(o,i).catch((function(e){console.error(e)})),n<=r)break}this._removeFromCache()}},{key:"decache",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e?this._removeFromCache():this._convertToImages()}}]),a}(c.ImageVolume);var O=function(e){v(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return I(this,e)});function a(e,t){var r;return m(this,a),b(h(r=n.call(this,e,t)),"getImageLoadRequests",(function(e){var t=h(r).imageIds,n=r.scalarData;return r.getImageIdsRequests(t,n,e)})),r}return g(a,[{key:"getScalarData",value:function(){return this.scalarData}}]),a}(_),T=c.utilities.createUint8SharedArray,k=c.utilities.createFloat32SharedArray,R=c.utilities.createUint16SharedArray,F=c.utilities.createInt16SharedArray,A=function(e,r){if(!r||!r.imageIds||!r.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");var a=(0,c.getConfiguration)().rendering,o=a.useNorm16Texture,i=a.preferSizeOverAccuracy,m=o||i;function d(){return(d=n(s().mark((function a(){var o,i,d,g,h,p,v,y,I,w,b,P,x,S,E,D,L,_,A,j,M,B,C,U,V,N,q,z,G,W,Y,H,Z,X;return s().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if("wadouri"!==r.imageIds[0].split(":")[0]){a.next=5;break}return o=[Math.floor(r.imageIds.length/2),r.imageIds.length-1],i=[0,o[0],o[1]],a.next=5,Promise.all(i.map((function(t){return new Promise((function(a,o){var i=r.imageIds[t];c.imageLoadPoolManager.addRequest(n(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c.imageLoader.loadImage(i).then((function(){console.log("Prefetched imageId: ".concat(i)),a(!0)})).catch((function(e){o(e)}));case 1:case"end":return e.stop()}}),e)}))),c.Enums.RequestType.Prefetch,{volumeId:e},1)}))}))).catch(console.error);case 5:d=r.imageIds,g=l(d),h=Math.floor(d.length/2),p=d[h],v=c.utilities.getScalingParameters(p),y=v.rescaleIntercept<0||v.rescaleSlope<0,I=g.BitsAllocated,w=g.PixelRepresentation,b=g.PhotometricInterpretation,P=g.ImageOrientationPatient,x=g.PixelSpacing,S=g.Columns,E=g.Rows,D=u.vec3.fromValues(P[0],P[1],P[2]),L=u.vec3.fromValues(P[3],P[4],P[5]),_=u.vec3.create(),u.vec3.cross(_,D,L),A=f(d,_),j=A.zSpacing,M=A.origin,B=A.sortedImageIds,C=d.length,U=[x[1],x[0],j],V=[S,E,C],N=[].concat(t(D),t(L),t(_)),q=1===w,z="RGB"===b?3:1,G=(0,c.getShouldUseSharedArrayBuffer)(),W=V[0]*V[1]*V[2],Y=function(e){if(!c.cache.isCacheable(e))throw new Error(c.Enums.Events.CACHE_SIZE_EXCEEDED);c.cache.decacheIfNecessaryUntilBytesAvailable(e)},a.t0=I,a.next=8===a.t0?29:16===a.t0?35:24===a.t0?52:56;break;case 29:if(!q){a.next=31;break}throw new Error("8 Bit signed images are not yet supported by this plugin.");case 31:return Y(Z=W),H=G?T(W):new Uint8Array(W),a.abrupt("break",56);case 35:if(m){a.next=39;break}return Z=4*W,H=G?k(W):new Float32Array(W),a.abrupt("break",56);case 39:if(Z=2*W,!q&&!y){a.next=44;break}return Y(Z),H=G?F(W):new Int16Array(W),a.abrupt("break",56);case 44:if(q||y){a.next=48;break}return Y(Z),H=G?R(W):new Uint16Array(W),a.abrupt("break",56);case 48:return Y(Z=4*W),H=G?k(W):new Float32Array(W),a.abrupt("break",56);case 52:return Y(Z=W*z),H=G?T(W*z):new Uint8Array(W*z),a.abrupt("break",56);case 56:return X=new O({volumeId:e,metadata:g,dimensions:V,spacing:U,origin:M,direction:N,scalarData:H,sizeInBytes:Z},{imageIds:B,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}}),a.abrupt("return",X);case 58:case"end":return a.stop()}}),a)})))).apply(this,arguments)}var g=function(){return d.apply(this,arguments)}();return{promise:g,decache:function(){g.then((function(e){e.destroy(),e=null}))},cancel:function(){g.then((function(e){e.cancelLoading()}))}}};function j(e){var t,r=e.map((function(e){var t=c.metaData.get("petImageModule",e),r=(null!=t?t:{}).frameReferenceTime;return{imageId:e,frameReferenceTime:void 0===r?0:r}})),n=(t="frameReferenceTime",r.reduce((function(e,r){return(e[r[t]]=e[r[t]]||[]).push(r),e}),{})),a=Object.keys(n).map(Number.parseFloat).sort((function(e,t){return e-t})).map((function(e){return n[e].map((function(e){return e.imageId}))}));return a}var M=c.utilities.createUint8SharedArray,B=c.utilities.createFloat32SharedArray;var C=function(e){v(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return I(this,e)});function a(e,t){var r;return m(this,a),a._ensureValidData(e,t),b(h(r=n.call(this,e,t)),"_numTimePoints",void 0),b(h(r),"_timePoints",void 0),b(h(r),"_timePointIndex",0),b(h(r),"_getTimePointRequests",(function(e,t){var n=e.imageIds,a=e.scalarData;return r.getImageIdsRequests(n,a,t)})),b(h(r),"_getTimePointsRequests",(function(e){var t=r._getTimePointsToLoad(),n=[];return t.forEach((function(t){var a=r._getTimePointRequests(t,e);n=n.concat(a)})),n})),b(h(r),"getImageLoadRequests",(function(e){return r._getTimePointsRequests(e).reverse()})),r._numTimePoints=r.scalarData.length,r._timePoints=r._getTimePointsData(),r}return g(a,[{key:"_getTimePointsData",value:function(){for(var e=this.imageIds,t=this.scalarData,r=this.numFrames,n=t.length,a=[],o=0;o<n;o++){var i=o*r,s=i+r;a.push({imageIds:e.slice(i,s),scalarData:t[o]})}return a}},{key:"_getTimePointsToLoad",value:function(){for(var e=this._timePoints,t=this._timePointIndex,r=[e[t]],n=t-1,a=t+1;n>=0||a<e.length;)n>=0&&r.push(e[n--]),a<e.length&&r.push(e[a++]);return r}},{key:"isDynamicVolume",value:function(){return!0}},{key:"timePointIndex",get:function(){return this._timePointIndex},set:function(e){if(e<0||e>=this.numTimePoints)throw new Error("Invalid timePointIndex (".concat(e,")"));if(this._timePointIndex!==e){var t=this.imageData;this._timePointIndex=e,t.getPointData().setActiveScalars("timePoint-".concat(e)),this.invalidateVolume(!0)}}},{key:"numTimePoints",get:function(){return this._numTimePoints}},{key:"getScalarData",value:function(){return this.scalarData[this._timePointIndex]}}],[{key:"_ensureValidData",value:function(e,t){var r=t.imageIds,n=e.scalarData;if(r.length%n.length!=0)throw new Error("Number of imageIds is not a multiple of ".concat(n.length))}}]),a}(_);function U(e){return function(e){for(var t=[j],r=function(r){var n=t[r](e);if(!n||n.length<=1)return"continue";var a=n[0].length;return n.every((function(e){return e.length===a}))?{v:n}:void 0},n=0;n<t.length;n++){var a=r(n);if("continue"!==a&&"object"===y(a))return a.v}return[e]}(e).map((function(e){return function(e){var r=l(e),n=r.BitsAllocated,a=r.PixelRepresentation,o=r.PhotometricInterpretation,i=r.ImageOrientationPatient,s=r.PixelSpacing,m=r.Columns,d=r.Rows,g=u.vec3.fromValues(i[0],i[1],i[2]),h=u.vec3.fromValues(i[3],i[4],i[5]),p=u.vec3.create();u.vec3.cross(p,g,h);var v=f(e,p),y=v.zSpacing,I=v.origin,w=v.sortedImageIds,b=e.length,P=[s[1],s[0],y],x=[m,d,b],S=[].concat(t(g),t(h),t(p)),E=1===a,D=1;"RGB"===o&&(D=3);var L,_=(16===n?4:1)*x[0]*x[1]*x[2]*D;if(!c.cache.isCacheable(_))throw new Error(c.Enums.Events.CACHE_SIZE_EXCEEDED);switch(c.cache.decacheIfNecessaryUntilBytesAvailable(_),n){case 8:if(E)throw new Error("8 Bit signed images are not yet supported by this plugin.");L=M(x[0]*x[1]*x[2]);break;case 16:L=B(x[0]*x[1]*x[2]);break;case 24:L=M(x[0]*x[1]*x[2]*D)}return{metadata:r,sortedImageIds:w,dimensions:x,spacing:P,origin:I,direction:S,scalarData:L,sizeInBytes:_}}(e)}))}var V=function(e,t){if(!t||!t.imageIds||!t.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");var r=U(t.imageIds),n=r[0],a=n.metadata,o=n.dimensions,i=n.spacing,s=n.origin,c=n.direction,u=n.sizeInBytes,l=[],f=[];r.forEach((function(e){l.push(e.sortedImageIds),f.push(e.scalarData)}));var m=new C({volumeId:e,metadata:a,dimensions:o,spacing:i,origin:s,direction:c,scalarData:f,sizeInBytes:u},{imageIds:l.flat(),loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(m),decache:function(){m.destroy(),m=null},cancel:function(){m.cancelLoading()}}}}(),o}()}));
//# sourceMappingURL=index.js.map